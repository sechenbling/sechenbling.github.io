---
title: Data Warehouse Model
author: Lynn
date: 2023-01-28 21:30:00 +0800
last_modified_at: 2023-01-28 21:35:00 +0800
categories: [Bigdata, DataWarehouse]
tags: [data warehouse]
syntax: colorful
---

## 数据仓库介绍
### 数据仓库
- 用于存储分析报告的数据系统
  + 并不产生数据（数据来自于外部系统） 也不消费数据（其结果开放给外部应用使用）
- 构建面向分析的集成化数据环境，分析结构提供决策
- 对比OLAP和OLTP
  + 各类型的数据库保存相关数据（关系型数据库是OLTP的典型应用） 但不会在数据库上直接分析数据 
  + 数据仓库是OLAP的一种实现 （OLAP 联机分析处理系统 面向分析 支持分析） 

### 数据仓库特点
- 面向主题subject oriented 主题抽象概念，在较高层次上数据综合、归类并分析利用的抽象
- 集成性integrated 主题相关的数据通常会分布在多个操作系统中，彼此分散独立异构，需要集成在数仓主题下
  + 数据进入数据仓库前需要经过统一和综合，对数据进行抽取、清理、转换和汇总
    * ETL：抽取 转换 加载
  + 统一数据源中的矛盾之处：同名异义 字长不统一等
  + 进行数据综合和计算
- 非易失性non-volatile 分析数据而非创造数据
  + 对数仓中的数据操作大多是查询或者数据挖掘，一般会保留较长时间
  + 查询操作较多，修改和删除操作较少
- 时变性time-variant 数据仓库的数据随着时间更新以适应决策的需要
  + 离线分析：需要随着时间更新以适应决策的需要

### 数仓开发语言SQL 
结构化查询语言：分析领域主流开发语言，SQL本身是针对数据库软件设计的，但是在大数据数仓领域，很多数仓都会支持SQL语法

## 数据仓库建模
### 仓库流程图
![img.png](/blog_imgs/data warehouse/theory/data warehouse modeling img1.png)
### 数据建模
数据组织和存储方法与数据的处理（建表+写SQL）
- 每一层的数据是具有依赖关系的，需要按链路流程下去
- 实时处理：流处理 stream
- 离线处理：批处理 batch(一般按照时间为单位来作为一批处理数据)
- 用途
  + 高性能：良好的数据模型能够帮助我们快速查询所需要的数据。
  + 低成本：良好的数据模型能减少重复计算，实现计算结果的复用，降低计算成本。
  + 高效率：良好的数据模型能极大的改善用户使用数据的体验，提高使用数据的效率。
  + 高质量：良好的数据模型能改善数据统计口径的混乱，减少计算错误的可能性。

### 数据建模工作流
每个工作流程之间是具有前后依赖关系的，需要保证前面的任务处理完才可以处理后续的任务，对每个工作流程的脚本需要控制对应的开启时间，可能存在时间错位，需要使用对应的调度工具来确保流程能够按顺序正常执行（只需指定开启的时间，而不需要指定每一步的时间）

### 数据仓库建模方法
- ER模型（并不是那么适合用于数据分析）：
  + 将复杂的数据抽象为两个概念，实体和关系，使用一系列范式设计数据库（通常是关系型数据库），减少数据冗余，增强数据一致性。当然一定的数据冗余可以提高查询的速率，提高性能。范式提高：数据冗余减少，数据一致性增强，表数量增多，查询性能降低。
  + 三范式：
    * 第一范式：属性不可再切分
    * 第二范式：表中不存在不分函数依赖 
    * 第三范式：表中不存在传递函数依赖
  + 对简单的需求可能需要跨越大量的表进行join操作才能获取到相应的数据，比较影响性能，并不适合直接用于分析统计操作。  
![img.png](/blog_imgs/data warehouse/theory/data warehouse modeling img2.png)
- 维度模型
  + 维度模型将业务通过事实和维度两个概念进行呈现，事实对应业务过程，而维度通常对应业务过程发生时所处的环境。抽象为事实表和维度表。关注于数据分析，如何更快完成需求分析和大规模复杂查询的相应性能。只需要通过一个事实表和其他维度表进行关联即可，使用维度表里的字段进行过滤。
  + 缺点在于数据冗余，比如Date中的年分，同一年中多天都是一个年份，但是放在大数据集群中对存储空间并不考虑，效率更重要（HDFS无限扩展）；此外更改数据时会出现数据一致性问题，不过数仓不会针对一条或几条数据进行更改，而是批量大规模更改。
  + 业务过程可以概括为一个个不可拆分的行为事件，比如商品下单等。
![img.png](/blog_imgs/data warehouse/theory/data warehouse modeling img3.png)


## 维度模型

### 事实表
包含与业务过程有关的维度引用（维度表外键）以及该业务过程的度量（可累加的数字类型字段）
- 分类：
  + 事务事实表：用于记录业务过程，保存的是各业务过程的原子操作，即最细粒度（每一条最小的操作记录）的操作事件。粒度是指事实表中一行数据表达的业务细节程度。
    * 设计过程：
      * 选择业务过程：一个业务过程对应一张事务事实表，确定需要建立哪些事实表（需求驱动） 
      * 声明粒度：定义事实表每行数据具体含义并尽可能确定最细粒度 
      * 确认维度：尽可能多的确定与每张事实表相关的维度（要与业务逻辑相关联），维度越丰富，维度模型所能支持的指标更丰富 
      * 确认事实：事实指每个业务过程的度量值（比如次数，个数等概念）
    * 不足之处：
      * 存量型指标：得到某个结果，需要涉及到两张事务事实表的结果进行结合才可以获得，需要对两张表的全表数据进行聚合才能得到结果，但是事务型事实表行多，效率较低。（非join操作关联表，指的是一个需求需要汇总一个或多个全表的数据，一个表行多数据多） 
      * 多事务关联统计：需要将多个事务型事实表进行join关联才能获取结果的情况，事实表行很多，join操作影响效率。
  + 周期快照事实表：以规律性，可预见的时间间隔来记录事实，用于分析一些存量型或者状态型指标
    * 对于存量型指标，只需定期同步一份数据到数仓后即可构建周期性快照事实表，基本都是针对于全量表进行这些操作。
    * 对于连续型指标（比如运动速度等连续的值），无法捕获其变动的原子事务操作，只能定期采样构建相关的周期型快照事实表。     
    * 同一个业务过程可以同时有事务型事实表和周期性快照事实表，两者并不冲突，是为了解决不同的问题，是一个互补的过程。     
    * 设计过程：
      * 确定粒度：粒度由采样周期（取决于需求）和维度描述（根据统计指标决定） 
        * 每日每个仓库中的每个商品的库存，粒度为每日-仓库-库存
      * 确认事实：根据统计指标决定，上例的事实为商品库存
    * 周期快照事实类型： 
      * 可加事实：可以按照事实表相关的所有维度进行相加，比如事务性事实表的事实
      * 半可加事实：只有一部分维度可以进行累加，比如周期型快照事实表，例子为上例的时间维度，相加没有意义，另外两个维度相加均有一定意义。
      * 不可加事实：完全不具备可加性：比如比率型事实，通常可以转化为可加事实，比如将比率转化为分子和分母，比如退货率=退货次数/下单次数 分为两个可加事实
  + 累计快照事实表：基于一个业务流程中的多个关键业务过程联合处理而构成的事实表：比如交易流程中的下单支付发货收获过程。表中的每一条数据都会根据流程逐渐更新。比如交易流程中各个过程的时间。
    * 设计过程：多个业务过程对应一张累计型快照事实表
    * 其余过程基本同事务型事实表

### 维度表
主要包括一个主键和各种维度字段，维度字段称为维度属性
- 设计步骤：
  + 确定维度：两个方面，第一每个与事实表相关的维度都有一个维度表，也存在多个事实和一个维度表相关的情况，这个时候需要保证维度表的唯一性；第二如果维度属性比较少，可以直接把维度表信息放入事实表中，称为维度退化，用于减少join操作。
  + 确定主维表和相关维表：主维表和相关维表都是指业务系统中与某些维度相关的表，比如商品维度衍生出来的其他与商品相关的信息，维度表的粒度通常与主维表相同。行与主维表一致，列来自相关维表。
  + 确定维度属性：维度属性主要来自于主维表和相关维表，也可以通过进一步处理衍生成一个维度属性
    * 维度属性确定需要以下需求：
      * 尽可能丰富维度属性：维度属性是分析统计时约束条件和分组字段的基本来源，是数据易用性的关键，维度属性的丰富直接影响能够支持的指标的丰富程度。
      * 尽量不适用编码，而是使用明确的文字说明，一般可以编码和文字共存
        * 比如MySQL中对于支付方式，存储的是代表为支付宝或者微信的编码，而不是直接存储支付宝或者微信这些文字，并生成对应的编码表，但是在维度表里面，尽可能使用明确的文字说明或者编码与文字共存
      * 尽量沉淀出通用的维度属性
      * 有些维度属性的获取需要比较复杂的逻辑处理，例如多个字段拼接处理，为了避免重复处理，可以将相关的维度属性沉淀到维度表中。
- 维度设计要点
  + 规范化和反规范化：
    * 规范化：减少数据冗余增强数据一致性
    * 反规范化：将多张表的数据冗余到一张表，目的是减少join操作提高查询性能
    * 数据仓库系统的主要目的是用于数据分析和统计，所以是否方便用户进行统计分析决定了模型的优劣。采用雪花模型，用户在统计分析的过程中需要大量的关联操作，使用复杂度高，同时查询性能很差，而采用星型模型，则方便、易用且性能好。所以出于易用性和性能的考虑，维度表一般是很不规范化的。
- 维度变化：维度属性通常不是静态的，是会随着时间变化的，数仓一个重要特点就是反应历史的变化，所以需要保存维度的历史状态。
  + 全量快照表：一定固定时间保存一份全量的维度数据，简单有效，但是浪费存储空间
  + 拉链表：更加高效的保存维度信息的历史状态，记录每条记录的生命周期，一旦一条记录的生命周期结束，就重新开始一条新的记录，并把当前日期放入生效开始日期，如果生命周期未结束，采用特殊值进行标记即可。拉链表比较适合数据会发生变化但是变化频率不高的维度表，频繁变化的维度还是全量快照表更好。
- 多值维度：事实表中一条记录对应维度表中的多条记录，比如订单事实表中的一条订单对应商品维度表中的多个商品，针对这种情况的解决方法如下：
  + 降低事实表的粒度（建议用）：例如将订单事实表的粒度由一个订单降低为一个订单中的一个商品项
  + 在事实表中设计多个维度值字段，每个字段保存一个维度id，这种方案只适合多值维度个数固定的情况
- 多值属性：维度表中的某个属性同时拥有多个值，但是多个值字段针对不同商品无法形容，比如手机的系统属性，而食物没有系统这个属性的情况
  + （通用方式）将多值属性放到一个字段当中，以键值对(k1:v1,k2:v2)的形式存储
  + 将多值属性放到多个字段，每个字段对应一个属性，这种方案只适用于多值属性个数固定的情况。
				
					
